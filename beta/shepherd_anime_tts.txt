      var chatDivId = 0;
      // upload image to user account

      async function uploadImageToS3(url, userId, text) {
        var formData = new FormData();
        formData.append("userId", userId);
        formData.append("imageUrl", url);

        const requestOptions = {
          method: "POST",
          body: formData,
          redirect: "follow",
        };

        await fetch("https://api.pawpal.ai/api/v1/user/upload", requestOptions)
          .then((response) => response.text())
          .then((result) => {
            const { timestamp, timeString } = createTimestamp();
            const message = `(${JSON.parse(result).imageUrl}) ${text}`;
            msg("bot", message, timeString);
          })
          .catch((error) => console.error(error));
      }
      // check is mobile or not
      function detectDevice() {
        const screenWidth = window.innerWidth;
        const screenHeight = window.innerHeight;

        if (screenWidth < 768) {
          return "Mobile";
        } else if (screenWidth >= 768 && screenWidth < 1024) {
          return "Tablet";
        } else {
          return "Desktop";
        }
      }

      // Speech recognition
      const recordBtn = document.querySelector(".button-12.w-button");
      let SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition,
        recognition,
        recording = false;

      recordBtn.addEventListener("click", () => {
        if (!isSendMsg) {
          if (!recording) {
            recordBtn.style.backgroundImage =
              "url('https://uploads-ssl.webflow.com/651a1e741b97af0938ef7dd5/66093a1fa9a1ca9e3d47c00d_MIC%20BUTTON-04.png')";
            isSendMsg = true;
            speechToText();
            recording = true;
          } else {
            stopRecording();
          }
        }
      });

      function stopRecording() {
        recognition.stop();
        recording = false;
        isSendMsg = false;
        const inputTextArea = document.querySelector(".userinput.w-input");
        recordBtn.style.backgroundImage =
          "url('https://uploads-ssl.webflow.com/651a1e741b97af0938ef7dd5/66093a1f4ffe765e2ecb43cf_MIC%20BUTTON-03.png')";
        recordBtn.classList.remove("recording");
      }

      function speechToText() {
        try {
          recognition = new SpeechRecognition();
          recognition.lang = "en";
          recognition.interimResults = true;
          recordBtn.classList.add("recording");
          recognition.start();
          recognition.onresult = (event) => {
            const speechResult = event.results[0][0].transcript;
            const inputTextArea = document.querySelector(".userinput.w-input");
            inputTextArea.textContent = speechResult;
            const getMaxCharSpan = document.querySelector(".max_char");
            getMaxCharSpan.style.display = "flex";
          };
          recognition.onspeechend = () => {
            speechToText();
          };
          recognition.onerror = (event) => {
            stopRecording();
            if (event.error === "no-speech") {
              // alert("No speech was detected. Stopping...");
            } else if (event.error === "audio-capture") {
              // alert(
              //   "No microphone was found. Ensure that a microphone is installed."
              // );
            } else if (event.error === "not-allowed") {
              // alert("Permission to use microphone is blocked.");
            } else if (event.error === "aborted") {
              // alert("Listening Stopped.");
            } else {
              // alert("Error occurred in recognition: " + event.error);
            }
          };
        } catch (error) {
          recording = false;
          recordBtn.style.backgroundImage =
            "('https://uploads-ssl.webflow.com/651a1e741b97af0938ef7dd5/66093a1f4ffe765e2ecb43cf_MIC%20BUTTON-03.png')";
        }
      }

      // List of links to choose from
      var linksArray = ["/beta/bernedoodle", "/beta/shepherd"];

      // Function to pick a random link
      function pickRandomLink() {
        var randomIndex = Math.floor(Math.random() * linksArray.length);
        var randomLink = linksArray[randomIndex];
        window.location.href = randomLink; // Redirects to the random link
      }

      // Add event listener to the button
      document.addEventListener("DOMContentLoaded", function () {
        var randomButton = document.getElementById("randomButton"); // Make sure to assign the correct ID to your button
        if (randomButton) {
          randomButton.addEventListener("click", pickRandomLink);
        }
      });

      // extract link from bot result
      // extract link from bot result
      function extractImageLink(message, timestamp, callback) {
        if (typeof message !== "string" || message.trim() === "") {
          return;
        }

        // extract string
        let index = message.indexOf(")");
        let resultText;
        if (index !== -1) {
          resultText = message.substring(index + 1);
        }

        const regex = /\((.*?)\)/;
        const match = message.match(regex);
        if (match && match.length > 1) {
          const imageLink = match[1];
          createCanvasImage(imageLink, timestamp, resultText);
          if (callback) callback({ url: imageLink, text: resultText });
        } else {
          if (callback) callback(false);
        }
      }

      // create canvas for image
      function createCanvasImage(imageLink, timestamp, resultText) {
        const deviceType = detectDevice();
        let chatContainer;
        if (deviceType === "Mobile") {
          chatContainer = document.querySelector(
            ".w-layout-blockcontainer.chat-container.breed.w-container"
          );
        } else {
          chatContainer = document.querySelector(".chat-container");
        }
        const chatBubble = document.createElement("div");
        chatBubble.classList.add("chat-bubble1", "bot"); // Create canvas element
        chatBubble.id = chatDivId + 1;
        const canvas = document.createElement("canvas");
        canvas.width = 230;
        canvas.height = 250;
        canvas.style.borderRadius = "15px";
        // Show loading indicator
        const loadingIndicator = document.createElement("div");
        loadingIndicator.style.cssText =
          "width:300px; height:300px;display:flex;justify-content:center; align-items:center;";
        loadingIndicator.textContent = "Loading";
        const image = document.createElement("img");
        image.style.width = "35px";
        image.src =
          "https://uploads-ssl.webflow.com/651a1e741b97af0938ef7dd5/65caaf100d2e9c6e6c2df009_bubble.svg";
        loadingIndicator.appendChild(image);
        chatBubble.appendChild(loadingIndicator);
        const textSpan = document.createElement("span");
        textSpan.textContent = resultText;
        const ctx = canvas.getContext("2d");
        const img = new Image();
        img.src = imageLink;
        scrollToLatestMessage();

        const chatBubbleText = document.createElement("div");

        const audio = document.createElement("audio");
        const playIcon = document.createElement("img");
        playIcon.style.cssText = `width:30px; height:30px;margin: unset;position: static;`;
        playIcon.src =
          "https://uploads-ssl.webflow.com/651a1e741b97af0938ef7dd5/6604f623c14ee6f1352ecd80_tts%20icons-04.png";
        playIcon.id = "play_speech" + (chatDivId + 1);
        audio.id = "speech" + (chatDivId + 1);
        chatDivId++;
        chatBubble.appendChild(audio);

        img.onload = async function () {
          loadingIndicator.remove();
          isSendMsg = false;
          chatBubble.appendChild(canvas);
          chatBubbleText.appendChild(textSpan);
          chatBubbleText.appendChild(timestamp);

          chatBubble.appendChild(chatBubbleText);
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          chatBubbleText.appendChild(audio);
          timestamp.style.cssText = `position: relative;justify-content: end;gap: 10px;display: flex;align-items: end;`;
          timestamp.appendChild(playIcon);
          scrollToLatestMessage();
        };
        chatContainer.appendChild(chatBubble);
        return;
      }

      /// call api of sentiment engine
      function sentimentEngine() {
        const myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/json");
        const getTextMessage = document.getElementsByTagName("textarea");

        const raw = JSON.stringify({
          message: getTextMessage[0].value,
        });

        const requestOptions = {
          method: "POST",
          headers: myHeaders,
          body: raw,
          redirect: "follow",
        };

        fetch(
          "https://api.pawpal.ai/api/v1/pawpal-ai/sentiment",
          requestOptions
        )
          .then((response) => response.text())
          .then((result) => {
            const check = checkMessage(JSON.parse(result));
          })
          .catch((error) => console.error(error));
      }

      const dogGlass =
        "https://uploads-ssl.webflow.com/651a1e741b97af0938ef7dd5/6616867974381ae653e4e93a_shepherd_Glasses.gif";
      const dogSeekingAttention =
        "https://uploads-ssl.webflow.com/651a1e741b97af0938ef7dd5/661510b5631f418434230701_shepherd-attention.gif";
      const dogHeardSomething =
        "https://uploads-ssl.webflow.com/651a1e741b97af0938ef7dd5/661686eede3e40c25d745742_shepherd_heardSomething.gif";
      const dogCompliments =
        "https://uploads-ssl.webflow.com/651a1e741b97af0938ef7dd5/661686bf37bd96364e5631ec_shepherd_Shining.gif";
      function checkMessage(result) {
        const image = document.querySelector("#image-container img");
        const imageMob = document.querySelector(".breed-block.moblie img");

        if (
          result.sentiment === "question being asked" &&
          imageMob.srcset !== dogGlass
        ) {
          if (image) {
            image.srcset = dogGlass;
            image.src = dogGlass;
          }
          if (imageMob) {
            imageMob.srcset = dogGlass;
            imageMob.src = dogGlass;
          }
        } else if (result.sentiment === "looking for attention") {
          if (image) {
            image.srcset = dogSeekingAttention;
            image.src = dogSeekingAttention;
          }
          if (imageMob) {
            imageMob.srcset = dogSeekingAttention;
            imageMob.src = dogSeekingAttention;
          }
        } else if (result.sentiment === "curiosity") {
          if (image) {
            image.srcset = dogHeardSomething;
            image.src = dogHeardSomething;
          }
          if (imageMob) {
            imageMob.srcset = dogHeardSomething;
            imageMob.src = dogHeardSomething;
          }
        } else if (result.sentiment === "compliments") {
          if (image) {
            image.srcset = dogCompliments;
            image.src = dogCompliments;
          }
          if (imageMob) {
            imageMob.srcset = dogCompliments;
            imageMob.src = dogCompliments;
          }
        }

        const inputText = document.getElementsByTagName("textarea");
        if (inputText) {
          inputText[0].addEventListener("input", (e) => {
            if (e.target.value?.length == 0) {
              if (image) {
                image.srcset = dogSeekingAttention;
                image.src = dogSeekingAttention;
              }
              if (imageMob) {
                imageMob.srcset = dogSeekingAttention;
                imageMob.src = dogSeekingAttention;
              }
            }
          });
        }
        if (
          result.sentiment ===
          "the provided sentence does not exhibit any of the listed sentiments or behaviors."
        ) {
          if (image) {
            image.srcset = dogSeekingAttention;
            image.src = dogSeekingAttention;
          }
          if (imageMob) {
            imageMob.srcset = dogSeekingAttention;
            imageMob.src = dogSeekingAttention;
          }
        }
      }

      const debounce = function (fn, d) {
        let timer;
        return function () {
          let context = this,
            args = arguments;
          clearTimeout(timer);
          timer = setTimeout(() => {
            sentimentEngine.apply(context, arguments);
          }, d);
        };
      };

      // store conversation
      function insertMsg(data) {
        const myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/json");
        const requestOptions = {
          method: "POST",
          headers: myHeaders,
          body: data,
          redirect: "follow",
        };

        fetch("https://api.pawpal.ai/api/v1/chat", requestOptions)
          .then((response) => response.text())
          .then((result) => {
            return;
          })
          .catch((error) => {
            throw error;
          });
      }
      // get login details
      function getCookie(name) {
        const cookieValue = document.cookie.match(
          "(^|;)\\s*" + name + "\\s*=\\s*([^;]+)"
        );
        return cookieValue ? cookieValue.pop() : "";
      }

      // get breed id
      function breedId() {
        const url = window.location.href;
        const parts = url.split("/");
        const breed = parts[parts.length - 1].split(".")[0];
        return breed;
      }

      var firstUserId = getCookie("userId");
      var secondUserId = breedId();

      // get chat conversation
      function msg(sender, message, timestamp) {
        // Get all chat-bubble1 elements
        const chatBubbles = document.querySelectorAll(".chat-bubble1");

        // Initialize variables to store the last text and time for both user and bot
        let lastUserText = null;
        let lastUserTime = null;
        let lastBotText = null;
        let lastBotTime = null;

        // Iterate over each chat bubble
        chatBubbles.forEach((chatBubble) => {
          // Get the text content from the chat bubble
          const textContent = chatBubble?.textContent.trim();

          // Get the timestamp content from the chat bubble
          const timestamp = chatBubble
            .querySelector(".timestamp")
            ?.textContent?.trim();

          // Determine if it's from user or bot
          if (chatBubble?.classList?.contains("user")) {
            // Update last user text and time
            lastUserText = textContent;
            lastUserTime = timestamp;
          } else if (chatBubble?.classList?.contains("bot")) {
            // Update last bot text and time
            lastBotText = textContent;
            lastBotTime = timestamp;
          }
        });

        let conversation = [
          {
            from: firstUserId,
            to: secondUserId,
            time: lastUserTime,
            message: lastUserText,
          },
          {
            from: secondUserId,
            to: firstUserId,
            time: timestamp,
            message: message,
          },
        ];
        // Output the last text and time for both user and bot
        const data = JSON.stringify({
          firstUserId: firstUserId,
          secondUserId: secondUserId,
          date: new Date(),
          chat: [...conversation],
        });

        insertMsg(data);
      }

      // Function to scroll to the bottom of the chat container
      function scrollToLatestMessage(delay = 0) {
        const deviceType = detectDevice();
        let chatContainer;
        if (deviceType === "Mobile") {
          chatContainer = document.querySelector(
            ".w-layout-blockcontainer.chat-container.breed.w-container"
          );
        } else {
          chatContainer = document.querySelector(".chat-container");
        } // Delay scrolling slightly to account for the height change
        setTimeout(() => {
          chatContainer.scrollTop = chatContainer.scrollHeight;
          chatContainer.scrollIntoView({ block: "end" });
        }, delay);
      }

      // Function to generate random ID
      function getRandomId() {
        return Math.random().toString(36).substring(2, 10);
      }

      // Generate on page load
      const userId = getRandomId();

      // Function to post user's message to API
      async function postMessageToAPI(message) {
        // For adding bubble when thinking bot by made ravi
        // started
        const deviceType = detectDevice();
        let chatContainer;
        if (deviceType === "Mobile") {
          chatContainer = document.querySelector(
            ".w-layout-blockcontainer.chat-container.breed.w-container"
          );
        } else {
          chatContainer = document.querySelector(".chat-container");
        }
        const bubble = document.createElement("div");
        bubble.classList.add("chat-bubble1");
        bubble.classList.add("bot");
        bubble.classList.add("bubble");
        bubble.id = chatDivId + 1;
        const image = document.createElement("img");
        image.src =
          "https://uploads-ssl.webflow.com/651a1e741b97af0938ef7dd5/65caaf100d2e9c6e6c2df009_bubble.svg";
        image.style.marginBottom = "2px";
        image.style.width = "30px";
        image.style.bottom = "unset";
        image.style.left = "unset";
        chatContainer.style.marginBottom = "5px";
        const imageBreed = document.querySelector("#image-container img");
        // imageBreed.srcset =
        //   "https://uploads-ssl.webflow.com/651a1e741b97af0938ef7dd5/65df6f87fb7b84bf6452c80b_Thinking.gif";
        bubble.appendChild(image);
        chatContainer.appendChild(bubble);
        scrollToLatestMessage();
        // end

        const result = await query(message);
        if (result?.message?.outputs["out-2"]) {
          // remove bubble when get the result
          bubble.remove();
          // imageBreed.srcset =
          //   "https://uploads-ssl.webflow.com/651a1e741b97af0938ef7dd5/65df6f87bee691b1944db531_heardSomething.gif";
          const { timestamp, timeString } = createTimestamp(); // Create a timestamp for all messages

          extractImageLink(
            result?.message?.outputs["out-2"],
            timestamp,
            (res) => {
              var firstUserId = getCookie("userId");

              if (!res) {
                displayChatBubble("bot", result?.message?.outputs["out-2"]);
                scrollToLatestMessage();
              } else if (firstUserId) {
                uploadImageToS3(res.url, firstUserId, res.text);
              }
            }
          );
        }
      }
      async function query(message) {
        const myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/json");

        const raw = JSON.stringify({
          message: message,
        });

        const requestOptions = {
          method: "POST",
          headers: myHeaders,
          body: raw,
          redirect: "follow",
        };

        return await fetch(
          "https://api.pawpal.ai/api/v1/pawpal-ai/v3/german",
          requestOptions
        )
          .then((response) => response.text())
          .then((result) => {
            return JSON.parse(result);
          });
      }

      // get data from db of user
      function getOldData(callback) {
        const myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/json");

        const raw = JSON.stringify({
          firstUserId: firstUserId,
          secondUserId: secondUserId,
        });

        const requestOptions = {
          method: "POST",
          headers: myHeaders,
          body: raw,
          redirect: "follow",
        };

        fetch("https://api.pawpal.ai/api/v1/chat/list", requestOptions)
          .then((response) => response.text())
          .then((result) => {
            if (callback)
              callback(
                JSON.parse(result).result.length > 0
                  ? JSON.parse(result).result[0].chat
                  : []
              );
          })
          .catch((error) => console.error(error));
      }

      // get speech

      async function getSpeech(text) {
        const myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/json");
        const raw = JSON.stringify({
          text,
          voice: "21m00Tcm4TlvDq8ikWAM",
          voice_settings: {
            stability: 0,
            similarity_boost: 0,
          },
        });

        const requestOptions = {
          method: "POST",
          headers: myHeaders,
          body: raw,
          redirect: "follow",
        };

        try {
          const response = await fetch(
            "https://api.pawpal.ai/api/v1/chat/tts",
            requestOptions
          );
          if (!response.ok) {
            throw new Error("Network response was not ok.");
          }
          const result = await response.text();
          // const audioTag= document.querySelector('audio');
          // console.log(audioTag)
          // audioTag.setAttribute('src',JSON.parse(result).audioDataURI);
          // const getPlayBtn = document.getElementById("play_speech");
          //     if (getPlayBtn) getPlayBtn.style.display = "block";
          return JSON.parse(result).audioDataURI;
        } catch (error) {
          console.error(error);
          // Optionally handle error here or rethrow it
          throw error;
        }
      }
      // create html conversation
      async function conversationFromDb(callback) {
        getOldData(async (chatData) => {
          const deviceType = detectDevice();
          let chatContainer;
          if (deviceType === "Mobile") {
            chatContainer = document.querySelector(
              ".w-layout-blockcontainer.chat-container.breed.w-container"
            );
          } else {
            chatContainer = document.querySelector(".chat-container");
          } // Loop through the chat data
          chatData.forEach((chat, i) => {
            if (chat.from === firstUserId && chat.message) {
              const chatBubble = document.createElement("div");
              chatBubble.classList.add("chat-bubble1", "user");
              chatBubble.id = chatDivId + 1;
              chatDivId++;
              chatBubble.style.display = "flex";
              (chatBubble.style.flexDirection = "column"),
                (chatBubble.style.gap = "5px");
              const newMsg = chat.message.replace(chat.time, "").trim();
              const textSpan = document.createElement("span");
              textSpan.textContent = newMsg;
              chatBubble.appendChild(textSpan);

              const timestamp = document.createElement("span");
              timestamp.style.display = "flex";
              timestamp.style.justifyContent = "end";
              timestamp.textContent = chat.time;
              chatBubble.appendChild(timestamp);

              chatContainer.appendChild(chatBubble);
            } else if (chat.from === secondUserId && chat.message) {
              const newMsg = chat.message.replace(chat.time, "").trim();

              const timestamp = document.createElement("span");
              timestamp.style.display = "flex";
              timestamp.style.justifyContent = "end";
              timestamp.textContent = chat.time;
              extractImageLink(newMsg, timestamp, async (res) => {
                if (!res) {
                  const chatBubble = document.createElement("div");
                  chatBubble.classList.add("chat-bubble1", "bot");
                  chatBubble.id = chatDivId + 1;
                  // TTS logic start
                  timestamp.style.cssText = `position: relative;justify-content: end;gap: 10px;display: flex;align-items: end;`;
                  const audio = document.createElement("audio");
                  const playIcon = document.createElement("img");
                  playIcon.style.cssText = `width:30px; height:30px;margin: unset;position: static;`;
                  playIcon.src =
                    "https://uploads-ssl.webflow.com/651a1e741b97af0938ef7dd5/6604f623c14ee6f1352ecd80_tts%20icons-04.png";
                  playIcon.id = "play_speech" + (chatDivId + 1);
                  audio.id = "speech" + (chatDivId + 1);
                  chatDivId++;

                  chatBubble.appendChild(audio);

                  // TTS logic end
                  chatBubble.style.display = "flex";
                  (chatBubble.style.flexDirection = "column"),
                    (chatBubble.style.gap = "5px");

                  const textSpan = document.createElement("span");
                  textSpan.textContent = newMsg;

                  chatBubble.appendChild(textSpan);

                  chatBubble.appendChild(timestamp);
                  chatContainer.appendChild(chatBubble);
                  timestamp.appendChild(playIcon);
                }
              });
            }
          });
          await new Promise((resolve) => setTimeout(resolve, 0));

          if (callback) callback(chatData);
        });
      }
      // Function to display chat bubbles with live typing effect

      async function displayChatBubble(sender, message) {
        const deviceType = detectDevice();
        let chatContainer;
        if (deviceType === "Mobile") {
          chatContainer = document.querySelector(
            ".w-layout-blockcontainer.chat-container.breed.w-container"
          );
        } else {
          chatContainer = document.querySelector(".chat-container");
        }
        const bubble = document.createElement("div");
        bubble.id = chatDivId + 1;
        bubble.classList.add("chat-bubble1");
        const { timestamp, timeString } = createTimestamp(); // Create a timestamp for all messages

        if (sender === "user") {
          bubble.classList.add("user");
          bubble.innerHTML = message; // Display the message as is
          bubble.appendChild(timestamp); // Append the timestamp for user messages
          chatContainer.appendChild(bubble);
        } else if (sender === "bot") {
          if (firstUserId) {
            msg(sender, message, timeString);
          }
          bubble.classList.add("bot");
          chatContainer.appendChild(bubble);
          // Check if the message contains a link and replace it with an anchor tag
          // started
          const linkPattern = /\[(.*?)\]\s?\((.*?)\)/;
          if (linkPattern.test(message)) {
            const [fullMatch, linkText, linkUrl] = message.match(linkPattern);
            const linkElement = document.createElement("a");
            linkElement.href = linkUrl;
            linkElement.textContent = linkText;
            linkElement.target = "_blank"; // Open link in new tab
            message = message.replace(fullMatch, linkElement.outerHTML);
            liveTypeMessageWithLInk(bubble, message, timestamp);
          } else {
            liveTypeMessage(bubble, message, timestamp, timeString); // Pass the timestamp to the typing effect function
          }

          // end
        }
        scrollToLatestMessage();
      }

      // when bot return some link in result
      // started
      function liveTypeMessageWithLInk(element, message, timestamp) {
        let i = 0;
        const typingSpeed = 50; // milliseconds

        function typeChar() {
          scrollToLatestMessage();
          if (i < message.length) {
            if (message.charAt(i) === "<") {
              // Check if the current character is part of an HTML tag
              let endIndex = message.indexOf(">", i); // Find the closing bracket of the tag
              if (endIndex !== -1) {
                element.innerHTML += message.substring(i, endIndex + 1);
                i = endIndex + 1; // Move the index to after the closing bracket
              } else {
                // If closing bracket not found, treat it as a regular character
                element.innerHTML += message.charAt(i);
                i++;
              }
            } else {
              element.innerHTML += message.charAt(i);
              i++;
            }
            scrollToLatestMessage();

            setTimeout(typeChar, typingSpeed);
          } else {
            var containers = document.getElementsByClassName("chat-bubble1");
            // Loop through each element
            for (let i = 0; i < containers.length; i++) {
              var text = containers[i].textContent;

              // Regular expression to match URLs
              var urlRegex = /(https?:\/\/[^\s.]+\.[^\s]+)/g;

              // Replace URLs with anchor tags
              var replacedText = text.replace(urlRegex, function (url) {
                // If URL ends with a period, remove it
                if (url.endsWith(".")) {
                  url = url.slice(0, -1);
                }
                return '<a href="' + url + '" target="_blank">' + url + "</a>";
              });

              // Update the HTML of the element with the replaced text
              containers[i].innerHTML = replacedText;
            }
            element.appendChild(timestamp); // Append the timestamp after the message is typed
            scrollToLatestMessage();
          }
        }

        typeChar();
      }
      // ended

      // Function to simulate live typing
      function liveTypeMessage(element, message, timestamp, timeString) {
        let i = 0;
        const typingSpeed = 50; // milliseconds

        async function typeChar() {
          if (i < message.length) {
            element.textContent += message.charAt(i);
            i++;
            scrollToLatestMessage();
            setTimeout(typeChar, typingSpeed);
          } else {
            scrollToLatestMessage();
            isSendMsg = false;
            // tts logic start

            const audio = document.createElement("audio");
            const playIcon = document.createElement("img");
            playIcon.style.cssText = `width:30px; height:30px;margin: unset;position: static;`;
            playIcon.src =
              "https://uploads-ssl.webflow.com/651a1e741b97af0938ef7dd5/6604f623c14ee6f1352ecd80_tts%20icons-04.png";
            playIcon.id = "play_speech" + (chatDivId + 1);
            audio.id = "speech" + (chatDivId + 1);
            chatDivId++;
            element.appendChild(audio);
            timestamp.style.cssText = `gap: 10px;display: flex;align-items: end;`;
            timestamp.appendChild(playIcon);
            element.appendChild(timestamp); // Append the timestamp after the message is typed

            //   scrollToLatestMessage();
            // }
          }
        }
        typeChar();
      }

      // Function to create a timestamp span
      function createTimestamp() {
        const timestamp = document.createElement("span");
        const now = new Date();
        const timeString =
          now.getHours().toString().padStart(2, "0") +
          ":" +
          now.getMinutes().toString().padStart(2, "0");
        timestamp.textContent = timeString;
        timestamp.classList.add("timestamp");
        return { timestamp, timeString };
      }

      // Function to clear the user input field
      function clearUserInput() {
        document.querySelector(".userinput").value = "";
      }

      var isSendMsg = false;

      // Event listener for the submit button
      document
        .querySelector(".sendbutton")
        .addEventListener("click", function (e) {
          e.preventDefault();
          if (isSendMsg) return;
          else {
            isSendMsg = true;
            document.activeElement.blur();
            const inputElement = document.querySelector(".sendbutton")?.blur();
            const userMessage = document
              .querySelector(".userinput")
              .value.trim(); // Trim the input
            if (userMessage.length >= 2) {
              const getMaxCharSpan = document.querySelector(".max_char");
              getMaxCharSpan.style.display = "none";
              // Check if the message has at least 2 characters
              displayChatBubble("user", userMessage);
              postMessageToAPI(userMessage);
              clearUserInput();
              scrollToLatestMessage();
            }
          }
        });

      // replace img with video

      function replaceImageWithVideo(video) {
        const imageMob = document.querySelector(".breed-block.moblie img");
        var classes = imageMob.classList;
        classes.forEach(function (className) {
          video.classList.add(className);
        });
        var styleAttribute = imageMob.getAttribute("style");
        video.setAttribute("style", styleAttribute);
        var source = document.createElement("source");
        source.setAttribute(
          "src",
          "https://pawpal.s3.amazonaws.com/animation/shepherd/shepherd_mask.webm"
        );
        source.setAttribute("type", "video/webm");
        video.setAttribute("loop", "");
        video.appendChild(source);
        video.setAttribute("autoplay", "");
        const deviceType = detectDevice();
        const imageN = document.querySelector("#image-container img");

        if (deviceType === "Mobile") {
          imageMob.parentNode.appendChild(video);
        } else {
          const imageNewCont = document.querySelector("#image-container");
          var divWidth = imageNewCont.offsetWidth;
          var divHeight = imageNewCont.offsetHeight;
          video.style.height = divHeight + "px";
          video.style.width = divWidth + "px";

          imageNewCont.style.display = "flex";
          imageNewCont.appendChild(video);
        }

        video.addEventListener("loadeddata", function () {
          console.log(imageN);
          if (deviceType === "Mobile") {
            imageMob.style.display = "none";
          } else imageN.style.display = "none";
        });
      }
      var isPlaying = false;

      document.addEventListener("DOMContentLoaded", function () {
        const image = document.querySelector("#image-container img");
        const imageMob = document.querySelector(".breed-block.moblie img");

        // play tts logic
        function TtsLogic(playIcon, audio) {
          if (audio.src) {
            if (isPlaying) {
              pauseAudio();
            } else {
              playAudio();
            }
          }
          function playAudio() {
            isPlaying = true;
            audio.play();
            playIcon.src =
              "https://uploads-ssl.webflow.com/651a1e741b97af0938ef7dd5/661686601c36e53c9c3b1964_tts_active.png";
          }

          function pauseAudio() {
            isPlaying = false;
            audio.pause();
            playIcon.src =
              "https://uploads-ssl.webflow.com/651a1e741b97af0938ef7dd5/6604f623c14ee6f1352ecd80_tts%20icons-04.png";
          }

          audio.addEventListener("ended", function () {
            isPlaying = false;
            playIcon.src =
              "https://uploads-ssl.webflow.com/651a1e741b97af0938ef7dd5/6604f623c14ee6f1352ecd80_tts%20icons-04.png";
            // imageMob.srcset = dogSeekingAttention;
            // image.srcset = dogSeekingAttention;
            // imageMob.src = dogSeekingAttention;
            // image.src = dogSeekingAttention;
          });
        }
        setTimeout(() => {
          var imagesPlayIcon = document.querySelectorAll("img");
          imagesPlayIcon.forEach((img) => {
            if (img.id.includes("play_speech")) {
              img.addEventListener("click", async function () {
                // if(imageMob){
                //   imageMob.srcset = "mask image";
                //   imageMob.src = "mask image";
                // }
                // if(image){
                //   image.srcset = "mask image";
                // image.src = "mask image";
                // }

                const parentDiv = img.parentNode.parentNode;
                const audio = document.getElementById("speech" + parentDiv.id);
                if (!audio.src) {
                  const textForSpeech = parentDiv.querySelector("span");
                  const resultTts = await getSpeech(textForSpeech.textContent);
                  audio.setAttribute("src", resultTts);
                }

                TtsLogic(img, audio);
              });
            }
          });
        }, 1000);
      });
      // Displaying the welcome message when the chat window loads
      window.onload = async function () {
        recordBtn.style.backgroundImage =
          "url('https://uploads-ssl.webflow.com/651a1e741b97af0938ef7dd5/66093a1f4ffe765e2ecb43cf_MIC%20BUTTON-03.png')";
        // check auth start region
        var firstUserId = getCookie("userId");
        function hideElementsExceptBody() {
          return new Promise(function (resolve, reject) {
            var elementsToHide = document.querySelectorAll("html *:not(body)");
            elementsToHide.forEach(function (element) {
              element.style.display = "none";
            });
            resolve();
          });
        }

        if (
          (window.location.href.includes("/user-profile") ||
            window.location.href.includes("/golden") ||
            window.location.href.includes("/pick-your-pal") ||
            window.location.href.includes("/bernedoodle") ||
            window.location.href.includes("/shepherd")) &&
          !firstUserId
        ) {
          hideElementsExceptBody()
            .then(function () {
              setTimeout(() => {
                if (confirm("Unauthorized, Login is required!")) {
                  window.location.href = "/log-in";
                }
              }, 50);
            })
            .catch(function (error) {
              console.error("Error hiding elements:", error);
            });
        }

        // check auth end region

        const headerWrapMob = document.querySelector(
          ".header-wrapper.moblie.chat"
        );
        if (headerWrapMob) headerWrapMob.style.margin = "unset";
        const signInUpBtn = document.querySelector(
          ".invite-friend.signin.w-button"
        );
        const signInOutBtn = document.querySelector(
          ".invite-friend.signin.signout.w-button"
        );
        var firstUserId = getCookie("userId");
        if (firstUserId) {
          signInUpBtn.style.display = "none";
          signInOutBtn.style.display = "block";
        } else {
          signInOutBtn.style.display = "none";
          signInUpBtn.style.display = "block";
        }
        const image = document.querySelector("#image-container img");
        const imageMob = document.querySelector(".breed-block.moblie img");
        if (image) {
          image.srcset = dogSeekingAttention;
          image.src = dogSeekingAttention;
        }
        if (imageMob) {
          imageMob.srcset = dogSeekingAttention;
          imageMob.src = dogSeekingAttention;
        }

        const inputElement = document.querySelector(".userinput");
        const textAreaElement = document.createElement("textarea");
        // Copy over attributes from the input to the textarea
        textAreaElement.className = inputElement.className;
        textAreaElement.id = inputElement.id;
        textAreaElement.name = inputElement.name;
        textAreaElement.placeholder = inputElement.placeholder;
        textAreaElement.required = inputElement.required;
        textAreaElement.maxLength = 356;

        textAreaElement.style.cssText = `
    overflow: auto;
    white-space: pre-wrap;
    resize: vertical;
    height: 10px; 
    max-height: 85px; 
  `;
        // Replace the input element with the textarea element in the DOM
        inputElement.parentNode.replaceChild(textAreaElement, inputElement);

        // animation
        let parentForMaxCharacter = document.querySelector(
          ".column-5.w-col.w-col-1"
        );
        let charSpan = document.createElement("span");
        charSpan.classList.add("max_char");
        charSpan.style.cssText =
          "color:red; font-size:12px;font-size: 12px; align-self: stretch;width: 100%;justify-content: center;display: flex;";
        const inputDivContainer = document.querySelector(
          ".column-4.w-col.w-col-10"
        );
        inputDivContainer.appendChild(charSpan);

        textAreaElement?.addEventListener("input", (e) => {
          adjustTextareaHeight(textAreaElement);
          if (e.target.value.length === 0) {
            charSpan.style.display = "none";
          } else {
            charSpan.style.display = "flex";
          }
          var remaining = 356 - e.target.value.length;
          charSpan.textContent = remaining + "/356 left";
        });

        const betterFunction = debounce(sentimentEngine, 400);

        textAreaElement.addEventListener("keyup", () => {
          betterFunction();
        });

        function adjustTextareaHeight(textAreaElement) {
          textAreaElement.style.height = "auto"; // Reset the height to auto
          textAreaElement.style.height =
            textAreaElement.scrollHeight > textAreaElement.clientHeight
              ? textAreaElement.scrollHeight + "px"
              : "50px"; // Set the height to match the content or 50px
        }

        // Event listener for Enter key press in the chat input field
        document
          .querySelector(".userinput.w-input")
          .addEventListener("keydown", function (event) {
            if (event.keyCode === 13 && !isSendMsg) {
              event.preventDefault();
              isSendMsg = true;
              document.activeElement.blur();
              const inputElement = document
                .querySelector(".sendbutton")
                ?.blur();
              scrollToLatestMessage();
              const userMessage = event.target.value.trim(); // Trim the input
              if (userMessage.length >= 2) {
                const getMaxCharSpan = document.querySelector(".max_char");
                getMaxCharSpan.style.display = "none";
                // Check if the message has at least 2 characters
                displayChatBubble("user", userMessage);
                postMessageToAPI(userMessage);
                clearUserInput();
              }
            } else return;
          });

        if (firstUserId) {
          // started
          const deviceType = detectDevice();
          let chatContainer;
          if (deviceType === "Mobile") {
            chatContainer = document.querySelector(
              ".w-layout-blockcontainer.chat-container.breed.w-container"
            );
          } else {
            chatContainer = document.querySelector(".chat-container");
          }
          const bubble = document.createElement("div");
          bubble.classList.add("chat-bubble1");
          bubble.id = chatDivId + 1;
          chatDivId++;
          bubble.classList.add("bot");
          bubble.classList.add("bubble");
          bubble.style.width = "100%";
          bubble.style.justifyContent = "center";
          bubble.style.alignItems = "center";
          bubble.style.display = "flex";
          const image = document.createElement("img");
          image.src =
            "https://uploads-ssl.webflow.com/651a1e741b97af0938ef7dd5/65caaf100d2e9c6e6c2df009_bubble.svg";
          image.style.marginBottom = "2px";
          image.style.width = "30px";
          image.style.bottom = "unset";
          image.style.left = "unset";
          chatContainer.style.marginBottom = "5px";
          bubble.textContent += "Loading";

          bubble.appendChild(image);
          chatContainer.appendChild(bubble);
          await conversationFromDb((data) => {
            if (data?.length === 0) {
              displayChatBubble(
                "bot",
                "Hello! I am here to offer guidance, support, and a dash of fun. What's your name?"
              );
            }
            bubble.remove();
            scrollToLatestMessage();
          });
        } else {
          displayChatBubble(
            "bot",
            "Hello! I am here to offer guidance, support, and a dash of fun. What's your name?"
          );
        }
      };
